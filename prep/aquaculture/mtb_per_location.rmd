---
title: "Maximal allowed biomass per aquaculture location"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
date: "`r Sys.Date()`"
output:
  html_document:
    css: '~/github/coastrisk/src/style_coast.css'
    toc: true
    toc_float: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: 
  pdf_document:
    toc: true
---

```{r setup, include=FALSE, }
knitr::opts_chunk$set(echo = TRUE, message=FALSE)
source('~/github/coastrisk/src/common.r')
```

```{r additional libraries, inlcude = FALSE, warning=F}
library(data.table)
library(vroom)
library(rebus)
library(here)
```

Here i will prepare a table on MTB (maximal tillat biomasse) per aquaculture production site.
Then i will join this table with production areas, for use in CoastRisk project.


# Load aquaculture registry data (provided by FISKEDIR in May 2019). There is also no data for year 2016
```{r}
year2010 <-read_excel(file.path("/Volumes/ftp.imr.no/Aquaculture/Akvakultur_tillatelser_2010_2018/2010-06-28 Register-internett.xlsx"), skip = 1)
year2011 <-read_excel(file.path("/Volumes/ftp.imr.no/Aquaculture/Akvakultur_tillatelser_2010_2018/2011-01-03 Register-internett.xlsx"), skip = 1)
year2012 <-read_excel(file.path("/Volumes/ftp.imr.no/Aquaculture/Akvakultur_tillatelser_2010_2018/2012-12-31 Register-internett.xlsx"),skip = 1)
year2013 <-read_excel(file.path( "/Volumes/ftp.imr.no/Aquaculture/Akvakultur_tillatelser_2010_2018/2013-12-30 Akvakulturregisteret.xlsx"),skip = 1)
year2014 <-read_excel(file.path( "/Volumes/ftp.imr.no/Aquaculture/Akvakultur_tillatelser_2010_2018/2015-01-05 Akvakulturregisteret.xlsx"),skip = 1)
year2015 <-read_excel(file.path("/Volumes/ftp.imr.no/Aquaculture/Akvakultur_tillatelser_2010_2018/2016-01-11 Akvakulturregisteret.xlsx"),skip = 1)
year2017 <-read_excel(file.path("/Volumes/ftp.imr.no/Aquaculture/Akvakultur_tillatelser_2010_2018/2018-01-01 Akvakulturregisteret.xlsx"),skip = 1)
year2018 <-read_excel(file.path("/Volumes/ftp.imr.no/Aquaculture/Akvakultur_tillatelser_2010_2018/2018-12-31 Akvakulturregisteret.xlsx"),skip = 1)

```

Now two tables for 2019 and 2020. Actually, the registration of production sites is done in January 2020 and January 2021, but i will consider these as data for 2019 and 2020, respectively.

```{r}
year2019 <-read_excel(file.path("/Volumes/ftp.imr.no/Aquaculture/Akvakultur_tillatelser_2020/2020-01-06 Akvakulturregisteret.xlsx"), skip=1)
year2020 <-read_excel(file.path("/Volumes/ftp.imr.no/Aquaculture/Akvakultur_tillatelser_2020/2021-01-04 Akvakulturregisteret.xlsx"), skip=1)
```

# Municipalities changes in 2020

Since i add data for year 2019 and 2020, there will be mismatches with municipalities' names in the production areas table, because some municipaities, like in Finnmark, got new numbers in 2020.
I can update municipalities' numbers in the year2020 table before i continue with further data curation.


```{r}
convert_mcp_2020 <- read_excel(file.path("../administrative/fylker_kommuner_2019_2020_changes.xlsx"))

colnames(convert_mcp_2020) <- c("county_nr_19", 
                                "county_name_19",
                                "municip_number_19",
                                "municip_name_19",
                                "county_nr_20", 
                                "county_name_20",
                                "municip_number_20",
                                "municip_name_20")

convert_mcp_2020$municip_number_20 <- as.character(convert_mcp_2020$municip_number_20)
```


```{r}
year2020_prep <- year2020 |> 
  left_join(convert_mcp_2020[,c("municip_number_19","municip_number_20")],
            by=c("LOK_KOMNR" = "municip_number_20")) |> 
  mutate(LOK_KOMNR = ifelse(is.na(municip_number_19),
                            LOK_KOMNR,
                            municip_number_19)) |> 
  select(-municip_number_19)
```


I need to homogenize data a bit before merging

```{r}
year2010<-year2010 %>% mutate(TILL_KAP = as.numeric(TILL_KAP),
                              LOK_KAP = as.numeric(LOK_KAP))


tillatelser2010_20 <- bind_rows(year2010, year2011, year2012, year2013, year2014, year2015, year2017, year2018, year2019, year2020_prep) %>%
  mutate(Year = c(
    rep(2010, nrow(year2010)),
    rep(2011, nrow(year2011)),
    rep(2012, nrow(year2012)),
    rep(2013, nrow(year2013)),
    rep(2014, nrow(year2014)),
    rep(2015, nrow(year2015)),
    rep(2017, nrow(year2017)),
    rep(2018, nrow(year2018)),
    rep(2019, nrow(year2019)),
    rep(2020, nrow(year2020_prep))
  )) %>%
  select(27, c(2:26))
         
```


# Clean the data
What are the production types that are in the table?
We will need only the rows related to salmon and trout since only these two types of aquacutlure are included in the project

```{r}
unique(tillatelser2010_20$PRODUKSJONSFORM)
```

But i can also sort by species, it is simpler
```{r}
unique(tillatelser2010_20$ART)
```

```{r}
str_view(tillatelser2010_20$ART, pattern = "ørret", match = T)#Regnbueørret
str_view(tillatelser2010_20$ART, pattern = "Ørret", match = T)#Ørret
```

```{r}
str_view(tillatelser2010_20$ART, pattern = "Laks", match = T)#Laks
```

Filter the rows for salmon and trout.
NB! The table includes main production farms  but also stamfisk and settesfisk

```{r}
mtb_prep <- tillatelser2010_20 |> 
  filter(ART %in% c("Laks", "Regnbueørret", "Ørret"))
```


Further data cleaning: remove columns that we don't need, rename columns to English

```{r}
mtb_prep2 <- mtb_prep |> 
  select(-c(
            NAVN,
            ADRESSE,
            POSTNR,
            POSTSTED,
            TILDELINGSTIDSPUNKT,
            TIDSBEGRENSET,
            TILL_KOMNR,
            TILL_KAP,
            TILL_KOM,
            FORMÅL,
            TILL_ENHET,
            LOK_PLASS,
            UTGÅR_DATO)) |> 
  rename(year = Year,
         production_form = PRODUKSJONSFORM,
         species = ART,
         location_number = LOK_NR,
         location_name = LOK_NAVN,
         municip_number = LOK_KOMNR,
         municip = LOK_KOM,
         environment = VANNMILJØ,
         location_capacity = LOK_KAP,
         units_of_capacity = LOK_ENHET,
         W_GEOWGS84 =  Ø_GEOWGS84
         ) |> 
  select(-2)
```

# Prepare production areas data

```{r}
mcp_prod <- read.csv(file.path("./data/raw/municipality_productionarea.csv"),sep = " ")
```

```{r}
mcp_prod_prep <- mcp_prod %>% 
  rename(county_number = fylkenummer,
         municip_number = kommunenummer,
         municip_name = komname,
         total_mcp_area = Totalt_areal_inkl_12nm,
         sea_mcp_area = Havflate_12nm,
         prod_area_id = id,
         prod_area_name = name
         ) %>% 
  select(-knum) %>% 
  mutate(
    prod_area_name = str_replace_all(
      prod_area_name, pattern = "->", replacement = "-"
    )
  ) %>% 
  mutate(
    prod_area_name = str_replace_all(
      prod_area_name, pattern = fixed("+"), replacement = "-"
    )
  )

mcp_prod_prep2 <- mcp_prod_prep %>% 
  mutate(municip_number =
           ifelse(
             str_count(municip_number, pattern = regex("[:digit:]")) == 3,
                       str_c("0",municip_number),
                       municip_number
             )
         )
```


# Merge mtb table and production areas

```{r}
mtb_prep3 <- mtb_prep2 |> 
left_join(mcp_prod_prep2[,c(
    "municip_number",
    "municip_name",
    "prod_area_id",
    "prod_area_name"
  )],
  by = "municip_number")
```

There were many occasions when production areas did not match municipalities in mtb table
```{r}
nonmatches <- mtb_prep3 |> 
      filter(is.na(prod_area_name)) |> 
                       group_by(municip_number, municip) |> 
                       tally()

nonmatches
      
```

Bjarkoy municipality merged with Harstad in 2013, so i will just add a new number 1903 and name Harstad. Later, if we want to aggregate all capacities per municipalities, we will just take a sum of capacities in Harstand and Bjarkoy


I will make changes in the municipalities' number in the mtb table and will merge again with production areas
I replace also municipalities' numbers for Trondelad, they are old in the mtb table but new in production areas table

Changes in municipalities' numbers table
```{r}
convert_mcp <- read_excel(file.path("../administrative/kommune_endringer_2000_2018.xlsx"))

convert_mcp_prep1 <-convert_mcp %>% 
  mutate(
    municip_number_old = str_trim(municip_number_old)) %>% 
   mutate(
     municip_number_new = str_trim(municip_number_new)) 
```



Change to a new number: Roros and Rissa (merged with Indre Fossen), Volda has number 1444 in the mtb table but 1519 in the production areas (it merged with other municipalities, 1444 was Horningdal before)
```{r}
mtb_prep4 <- mtb_prep2 |> 
  mutate(municip_number = replace(municip_number, municip_number == "1915", "1903")) |> 
  mutate(municip_number = replace(municip_number, municip_number == "1901", "1903")) |> 
  mutate(municip_number = replace(municip_number, municip_number == "1640", "5025")) |> 
  mutate(municip_number = replace(municip_number, municip_number == "1624", "5024")) |> 
  mutate(municip_number = replace(municip_number, municip_number == "1444", "1519")) 
```


```{r}
foo_trond <- mtb_prep4 |> 
  filter(municip_number >=1600 & municip_number < 1800) |> 
  left_join(convert_mcp_prep1[, c(1,3)], 
            by = c("municip_number" = "municip_number_old")) |> 
  mutate(municip_number = municip_number_new) |> 
  select(-municip_number_new)
```

Merge Trondelag municipalities with others.
Then I also adjust some number of municipalities, where there are only 3 digits, should be 0 in the front

```{r}
mtb_prep5 <- mtb_prep4 |> 
  filter(municip_number >= 1800 | municip_number < 1600) 



mtb_prep6 <- bind_rows(mtb_prep5, foo_trond) |> 
  mutate(municip_number =
           ifelse(
             str_count(municip_number, pattern = regex("[:digit:]")) == 3,
                       str_c("0",municip_number),
                       municip_number
             )) |> 
 left_join(mcp_prod_prep2[,c(
    "municip_number",
    "municip_name",
    "prod_area_id",
    "prod_area_name"
  )],
  by = "municip_number")
```

And check non-matches again
```{r}
sum(is.na(mtb_prep6$prod_area_name))

nonmatches2 <- filter(mtb_prep6, is.na(prod_area_name)) |> 
  group_by(municip, municip_number) |> 
  tally()

nonmatches2
```

These are ALL inland municipalities of Oppland, Hedmark, Buskerud, Telemark (expames are Viken, Alvdal, Elverum, Folldal, Nord-Aurdal). 
I just remove those rows.

```{r}
mtb_final <- mtb_prep6 |> 
  select(-municip) |> 
  rename(municip = municip_name) |> 
  filter(!is.na(prod_area_name)) |> 
  select(year, municip_number, municip, everything())
```




# Save the final table
```{r}
write.csv(mtb_final, "./data/output/locations_capacity_2010_2018.csv")
```


# Table on MATFISK with volume-measured capacity

The table above can be used to see how many production sites where there each year, but capacity cannot be compared between the areas - sometimes the measurement is tonn, sometines count and m3. I can only keep m3, kg and tonn-units observations, if we want to present the capacity as a comparable numeric variable.

Transform kg to tonn and m3 to tonn. I will only keep MATFISK because, usually, SETTEFISK and STAMFISK location capacities are measured as counts. Also keep only the observations where capacity is measured as tonn, kg or m3.

Conversion from m3 to tonns: ant m3 x 0,065 = ant ton

Note that some capacities arE zero, for instance, location 	13189 in 2014.
```{r}
mtb_prep7 <- mtb_final |> 
  filter(production_form %in% unique(str_subset(
    production_form, pattern = regex("[.]*MATFISK[ -]*"))
    )) |> 
  filter(units_of_capacity %in% c("KG", "TN", "M3")) |> 
  mutate(location_capacity = ifelse(units_of_capacity == "KG",
         location_capacity/1000,
         location_capacity)) |> 
  mutate(location_capacity = ifelse(units_of_capacity == "M3",
         location_capacity*0.065,
         location_capacity)) |> 
  rename(location_capacity_tonn = location_capacity) |> 
  select(-units_of_capacity)
```

How to specify pattern for MATFISK in regex
```{r}
 #zero_or_more((ANY_CHAR)) %R% "MATFISK" %R% zero_or_more(char_class(" -"))
```

# Save the updated table

```{r}
write.csv(mtb_prep7, "./data/output/locations_capacity_matfisk_only_2010_2018.csv", row.names = FALSE)
```




